<?xml version="1.0" encoding="utf-8" ?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <UsingTask TaskName="MyInlineTask"
              TaskFactory="RoslynCodeTaskFactory"
              AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll">
    <ParameterGroup>
      <StartDirectory ParameterType="System.String" Required="true" />
      <RepoRoot ParameterType="System.String" Output="true" />
    </ParameterGroup>
    <Task>
      <Using Namespace="System.IO"/>
      <Code Type="Fragment" Language="cs">
        <![CDATA[
          string dir = StartDirectory;
          while (!string.IsNullOrEmpty(dir) && !Directory.Exists(Path.Combine(dir, ".git")))
          {
              dir = Directory.GetParent(dir)?.FullName;
          }
          RepoRoot = dir ?? string.Empty;
          if(string.IsNullOrEmpty(RepoRoot) == false)
          {
              Log.LogMessage(MessageImportance.High, "Found repository root: " + RepoRoot);
          }
          else
          {
              Log.LogError($"Cannot find .git directory in a parent path of {StartDirectory}");
          }
         ]]>
      </Code>
    </Task>
  </UsingTask>

  <Target Name="MyTasks" AfterTargets="AfterBuild">
    <MyInlineTask StartDirectory="$(MSBuildProjectDirectory)">
      <Output PropertyName="Sum" TaskParameter="RepoRoot" />
    </MyInlineTask>
     <Message Text="The sum is $(Sum)" Importance="High" />
  </Target>
</Project>